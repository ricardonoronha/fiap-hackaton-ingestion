name: Deploy to local cluster (self-hosted Ubuntu)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted

    env:
      K8S_DIR: k8s

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Replace tokens in manifests
        uses: cschleiden/replace-tokens@v1
        with:
          files: |
            ["${{ env.K8S_DIR }}/**/*.yml","${{ env.K8S_DIR }}/**/*.yaml"]
        env:
          ImageName: ingestion-api:${{ github.run_number }}
          InfluxToken: ${{ secrets.INFLUXDB_TOKEN }}
          RabbitmqConnectionString: ${{ secrets.RABBITMQ_CONNECTION_STRING }}
          JwtIssuer: ${{ secrets.JWT_ISSUER }}
          JwtAudience: ${{ secrets.JWT_AUDIENCE }}
          JwtKey: ${{ secrets.JWT_KEY }}

      - name: Validate kubectl access (uses runner kubeconfig)
        shell: bash
        run: |
          set -e
          kubectl config current-context
          kubectl get nodes

      - name: Apply manifests
        shell: bash
        run: |
          set -e
          kubectl apply -f "${{ env.K8S_DIR }}" -R

      - name: Quick status
        shell: bash
        run: |
          kubectl get deploy,po,svc -A